$basePath = ''./exp-results/{^^.name}/{^^.startTime}/''
$imgType = svg
$showSensors = true
$deferred = true

$allTrainOutcomesF = f.each(mapF = $cachedQFun; of = ea.f.quality(of = ea.f.best()))

$consoleL = ea.l.console(
  eFunctions = [
    ea.f.size(of = ea.f.genotype(of = ea.f.best()));
    f.composition(of = $allTrainOutcomesF; then = $qAggregator)
  ];
  onlyLast = false
)

$trainQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-train-quality." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = f.composition(of = $allTrainOutcomesF; then = $qAggregator);
    yRange = m.range(min = 0; max = 1)
  );
  deferred = $deferred;
  type = $imgType
)

$trainMinQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-train-min-q." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = f.min(of = $allTrainOutcomesF);
    yRange = m.range(min = 0; max = 1)
  );
  deferred = $deferred;
  type = $imgType
)

$trainMaxQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-train-max-q." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = f.max(of = $allTrainOutcomesF);
    yRange = m.range(min = 0; max = 1)
  );
  deferred = $deferred;
  type = $imgType
)

$trainSims = (environment = (arena = $trainPlotArenas)
* [ds.e.navigation(nOfSensors = $nOfSensors; robotRadius = $robotRadius)])
* [ds.sat.fromEnvironment()]

$testSims = (environment = (arena = $testPlotArenas)
* [ds.e.navigation(nOfSensors = $nOfSensors; robotRadius = $robotRadius)])
* [ds.sat.fromEnvironment()]

$allTestOutcomesF = f.cached(of = f.each(
  mapF = $cachedQFun;
  of = f.as(
    name = "test.arenas";
    of = f.all(
      of = ea.f.solution();
      fs = (simulation = $testSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    )
  )
))

$testAvgQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-test-avg-q." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = f.avg(of = f.composition(of = ea.f.best(); then = $allTestOutcomesF));
    yRange = m.range(min = 0; max = 1)
  );
  deferred = $deferred;
  type = $imgType
)

$testMinQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-test-min-q." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = f.min(of = f.composition(of = ea.f.best(); then = $allTestOutcomesF));
    yRange = m.range(min = 0; max = 1)
  );
  deferred = $deferred;
  type = $imgType
)

$testMaxQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-test-max-q." + $imgType;
  plot = ea.plot.multi.xyExp(
    y = f.max(of = f.composition(of = ea.f.best(); then = $allTestOutcomesF));
    yRange = m.range(min = 0; max = 1)
  );
  deferred = $deferred;
  type = $imgType
)

$bestTrainTrajsSaverL = ea.l.saveForRun(
  path = $basePath + "{solver.name}-{randomGenerator.seed:%02d}/{problem.name}/best-train-trajs." + $imgType;
  of = ea.acc.lastBest();
  processor = viz.f.toMultiImage(
    drawer = ds.d.navigation(ioType = off; showSensors = $showSensors);
    of = f.all(
      of = ea.f.solution();
      fs = (simulation = $trainSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    );
    type = $imgType
  )
)

$bestTestTrajsSaverL = ea.l.saveForRun(
  path = $basePath + "{solver.name}-{randomGenerator.seed:%02d}/{problem.name}/best-test-trajs." + $imgType;
  of = ea.acc.lastBest();
  processor = viz.f.toMultiImage(
    drawer = ds.d.navigation(ioType = off; showSensors = $showSensors);
    of = f.all(
      of = ea.f.solution();
      fs = (simulation = $testSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    );
    type = $imgType
  )
)

$finalTrainQPlotL = ea.l.savePlotForExp(
  path = $basePath + "final-best-train-quality." + $imgType;
  plot = ea.plot.multi.yBoxplotExp(y = f.composition(of = $allTrainOutcomesF; then = $qAggregator));
  type = $imgType
)

$finalTestQPlotL = ea.l.savePlotForExp(
  path = $basePath + "final-best-test-avg-q." + $imgType;
  plot = ea.plot.multi.yBoxplotExp(y = f.avg(of = f.composition(of = ea.f.best(); then = $allTestOutcomesF)));
  type = $imgType
)

$finalMinTestQPlotL = ea.l.savePlotForExp(
  path = $basePath + "final-min-test-avg-q." + $imgType;
  plot = ea.plot.multi.yBoxplotExp(
    y = f.min(of = f.each(
      of = ea.f.all();
      mapF = f.avg(of = $allTestOutcomesF) 
    ))
  );
  type = $imgType
)

$archivesP = ea.l.savePlotForRun(
  path = $basePath + "{solver.name}-{randomGenerator.seed:%02d}/{problem.name}/me-archives." + $imgType;
  plot = ea.plot.single.me(values = [
    f.composition(of = f.each(of = ea.f.quality(); mapF = $cachedQFun); then = $qAggregator);
    f.avg(of = $allTestOutcomesF)
  ]);
  kCondition = predicate.matches(f = f.mappableKey(key = "solver.name"); regex = "me.*");
  type = $imgType
)

$archiveLLTrainTrajsSaverL = ea.l.saveForRun(
  path = $basePath + "{solver.name}-{randomGenerator.seed:%02d}/{problem.name}/archive-ll-train-trajs." + $imgType;
  of = acc.last();
  processor = viz.f.toMultiImage(
    drawer = ds.d.navigation(ioType = off; showSensors = $showSensors);
    of = f.all(
      of = ea.f.solution(of = f.first(of = f.sortedBy(
        of = ea.f.all();
        by = f.mathOp(
          op = add;
          args = [
            ea.function.meBin(of = f.nTh(n = 0; of = ea.f.meCoordinates()));
            ea.function.meBin(of = f.nTh(n = 1; of = ea.f.meCoordinates()))
          ]
        )
      )));
      fs = (simulation = $trainSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    );
    type = $imgType
  );
  kCondition = predicate.matches(f = f.mappableKey(key = "solver.name"); regex = "me.*")
)

$archiveHHTrainTrajsSaverL = ea.l.saveForRun(
  path = $basePath + "{solver.name}-{randomGenerator.seed:%02d}/{problem.name}/archive-hh-train-trajs." + $imgType;
  of = acc.last();
  processor = viz.f.toMultiImage(
    drawer = ds.d.navigation(ioType = off; showSensors = $showSensors);
    of = f.all(
      of = ea.f.solution(of = f.first(of = f.sortedBy(
        of = ea.f.all();
        reversed = true;
        by = f.mathOp(
          op = add;
          args = [
            ea.function.meBin(of = f.nTh(n = 0; of = ea.f.meCoordinates()));
            ea.function.meBin(of = f.nTh(n = 1; of = ea.f.meCoordinates()))
          ]
        )
      )));
      fs = (simulation = $trainSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    );
    type = $imgType
  );
  kCondition = predicate.matches(f = f.mappableKey(key = "solver.name"); regex = "me.*")
)

$archiveLHTrainTrajsSaverL = ea.l.saveForRun(
  path = $basePath + "{solver.name}-{randomGenerator.seed:%02d}/{problem.name}/archive-lh-train-trajs." + $imgType;
  of = acc.last();
  processor = viz.f.toMultiImage(
    drawer = ds.d.navigation(ioType = off; showSensors = $showSensors);
    of = f.all(
      of = ea.f.solution(of = f.first(of = f.sortedBy(
        of = ea.f.all();
        by = f.mathOp(
          op = subtract;
          args = [
            ea.function.meBin(of = f.nTh(n = 0; of = ea.f.meCoordinates()));
            ea.function.meBin(of = f.nTh(n = 1; of = ea.f.meCoordinates()))
          ]
        )
      )));
      fs = (simulation = $trainSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    );
    type = $imgType
  );
  kCondition = predicate.matches(f = f.mappableKey(key = "solver.name"); regex = "me.*")
)

$archiveHLTrainTrajsSaverL = ea.l.saveForRun(
  path = $basePath + "{solver.name}-{randomGenerator.seed:%02d}/{problem.name}/archive-hl-train-trajs." + $imgType;
  of = acc.last();
  processor = viz.f.toMultiImage(
    drawer = ds.d.navigation(ioType = off; showSensors = $showSensors);
    of = f.all(
      of = ea.f.solution(of = f.first(of = f.sortedBy(
        of = ea.f.all();
        reversed = true;
        by = f.mathOp(
          op = subtract;
          args = [
            ea.function.meBin(of = f.nTh(n = 0; of = ea.f.meCoordinates()));
            ea.function.meBin(of = f.nTh(n = 1; of = ea.f.meCoordinates()))
          ]
        )
      )));
      fs = (simulation = $trainSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    );
    type = $imgType
  );
  kCondition = predicate.matches(f = f.mappableKey(key = "solver.name"); regex = "me.*")
)
