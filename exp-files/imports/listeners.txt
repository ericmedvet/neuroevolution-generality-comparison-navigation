$basePath = ''./exp-results/{^^.name}/{^^.startTime}/''
$showSensors = true

$allTrainOutcomesF = f.each(mapF = $qFun; of = ea.f.quality(of = ea.f.best()))

$consoleL = ea.l.console(
  eFunctions = [
    f.composition(of = $allTrainOutcomesF; then = $qAggregator)
  ];
  onlyLast = false
)

$trainQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-train-quality.svg";
  plot = ea.plot.multi.xyExp(
    y = f.composition(of = $allTrainOutcomesF; then = $qAggregator);
    yRange = m.range(min = 0; max = 1)
  );
  type = svg
)

$trainMinQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-train-min-q.svg";
  plot = ea.plot.multi.xyExp(
    y = f.min(of = $allTrainOutcomesF);
    yRange = m.range(min = 0; max = 1)
  );
  type = svg
)

$trainMaxQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-train-max-q.svg";
  plot = ea.plot.multi.xyExp(
    y = f.max(of = $allTrainOutcomesF);
    yRange = m.range(min = 0; max = 1)
  );
  type = svg
)

$trainSims = (environment = (arena = $trainArenas)
* [ds.e.navigation(nOfSensors = $nOfSensors; robotRadius = $robotRadius)])
* [ds.sat.fromEnvironment()]

$testSims = (environment = (arena = $testArenas)
* [ds.e.navigation(nOfSensors = $nOfSensors; robotRadius = $robotRadius)])
* [ds.sat.fromEnvironment()]

$allTestOutcomesF = f.as(
  name = "test.arenas";
  of = f.each(
    mapF = $qFun;
    of = f.all(    
      of = ea.f.solution(of = ea.f.best());
      fs = (simulation = $testSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    )
  )
)

$testAvgQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-test-avg-q.svg";
  plot = ea.plot.multi.xyExp(
    y = f.avg(of = $allTestOutcomesF);
    yRange = m.range(min = 0; max = 1)
  );
  type = svg
)

$testMinQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-test-min-q.svg";
  plot = ea.plot.multi.xyExp(
    y = f.min(of = $allTestOutcomesF);
    yRange = m.range(min = 0; max = 1)
  );
  type = svg
)

$testMaxQPlotL = ea.l.savePlotForExp(
  path = $basePath + "best-test-max-q.svg";
  plot = ea.plot.multi.xyExp(
    y = f.max(of = $allTestOutcomesF);
    yRange = m.range(min = 0; max = 1)
  );
  type = svg
)

$bestTrainTrajsSaverL = ea.l.saveForRun(
  path = $basePath + "{solver.name}-{randomGenerator.seed:%02d}/best-train-trajs.svg";
  of = ea.acc.lastBest();
  processor = viz.f.toMultiImage(
    drawer = ds.d.navigation(ioType = off; showSensors = $showSensors);
    of = f.all(
      of = ea.f.solution();
      fs = (simulation = $trainSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    );
    type = svg
  )
)

$bestTestTrajsSaverL = ea.l.saveForRun(
  path = $basePath + "{solver.name}-{randomGenerator.seed:%02d}/best-test-trajs.svg";
  of = ea.acc.lastBest();
  processor = viz.f.toMultiImage(
    drawer = ds.d.navigation(ioType = off; showSensors = $showSensors);
    of = f.all(
      of = ea.f.solution();
      fs = (simulation = $testSims) * [ds.f.simulate(dT = $dT; tRange = $tRange)]
    );
    type = svg
  )
)
